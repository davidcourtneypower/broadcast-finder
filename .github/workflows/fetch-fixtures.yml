name: API Sports Integration

on:
  schedule:
    - cron: '0 */3 * * *'   # Fetch & Cleanup: Every 3 hours (12 AM, 6 AM, 12 PM, 6 PM UTC)
  workflow_dispatch:          # Allow manual trigger

jobs:
  fetch-fixtures:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Football Fixtures from API-Sports.io
        run: |
          curl -X POST "${{ secrets.PROJECT_URL }}/functions/v1/fetch-fixtures" \
            -H "Authorization: Bearer ${{ secrets.SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"sport":"football","dates":["today","tomorrow"],"trigger":"scheduled"}'

      - name: Fetch Basketball Fixtures from API-Sports.io
        run: |
          curl -X POST "${{ secrets.PROJECT_URL }}/functions/v1/fetch-fixtures" \
            -H "Authorization: Bearer ${{ secrets.SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"sport":"basketball","dates":["today","tomorrow"],"trigger":"scheduled"}'

  fetch-broadcasts:
    runs-on: ubuntu-latest
    needs: fetch-fixtures  # Run AFTER fixtures are fetched
    steps:
      - name: Fetch TV Broadcasts from TheSportsDB
        run: |
          curl -X POST "${{ secrets.PROJECT_URL }}/functions/v1/fetch-broadcasts" \
            -H "Authorization: Bearer ${{ secrets.SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"sports":["football","basketball"],"dates":["today","tomorrow"],"trigger":"scheduled"}'
        timeout-minutes: 10  # Allow for rate limiting delays (1 req/min on free tier)

  cleanup-old-data:
    runs-on: ubuntu-latest
    needs: fetch-broadcasts  # Run after broadcasts are fetched
    steps:
      - name: Cleanup Old Fixtures
        run: |
          curl -X POST "${{ secrets.PROJECT_URL }}/functions/v1/cleanup-old-data" \
            -H "Authorization: Bearer ${{ secrets.SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json"
